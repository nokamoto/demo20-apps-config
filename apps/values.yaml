namespace: local

authorizer:
  image: ghcr.io/nokamoto/demo20-apps/demo20-authorizer
  tag: cef5a078da73a9a34a34207b23fae5f553be448f

compute:
  image: ghcr.io/nokamoto/demo20-apps/demo20-compute
  tag: cef5a078da73a9a34a34207b23fae5f553be448f

computeautomatedtest:
  image: ghcr.io/nokamoto/demo20-apps/demo20-compute-automated-test
  tag: cef5a078da73a9a34a34207b23fae5f553be448f

iam:
  image: ghcr.io/nokamoto/demo20-apps/demo20-iam
  tag: cef5a078da73a9a34a34207b23fae5f553be448f

iamautomatedtest:
  image: ghcr.io/nokamoto/demo20-apps/demo20-iam-automated-test
  tag: cef5a078da73a9a34a34207b23fae5f553be448f

rdb:
  image: ghcr.io/nokamoto/demo20-apps/demo20-rdb
  tag: cef5a078da73a9a34a34207b23fae5f553be448f

rdbautomatedtest:
  image: ghcr.io/nokamoto/demo20-apps/demo20-rdb-automated-test
  tag: cef5a078da73a9a34a34207b23fae5f553be448f

resourcemanager:
  image: ghcr.io/nokamoto/demo20-apps/demo20-resourcemanager
  tag: cef5a078da73a9a34a34207b23fae5f553be448f

resourcemanagerautomatedtest:
  image: ghcr.io/nokamoto/demo20-apps/demo20-resourcemanager-automated-test
  tag: cef5a078da73a9a34a34207b23fae5f553be448f

mysql:
  mysqlUser: test
  mysqlPassword: test
  initializationFiles:
    init.sql: |-
      CREATE DATABASE cloud;

      GRANT ALL ON cloud.* TO 'test'@'%';

      USE cloud;

      CREATE TABLE resourcemanager_project (
          project_key BIGINT PRIMARY KEY AUTO_INCREMENT,
          project_id VARCHAR(256) UNIQUE,
          display_name VARCHAR(256)
      );

      CREATE TABLE compute_instance (
          instance_key BIGINT PRIMARY KEY AUTO_INCREMENT,
          instance_id VARCHAR(256) UNIQUE,
          parent_id VARCHAR(256),
          labels VARCHAR(256),
          FOREIGN KEY (parent_id) REFERENCES resourcemanager_project (project_id)
      );

      CREATE TABLE iam_permission (
          permission_key BIGINT PRIMARY KEY AUTO_INCREMENT,
          permission_id VARCHAR(256) UNIQUE
      );

      CREATE TABLE iam_role (
          role_key BIGINT PRIMARY KEY AUTO_INCREMENT,
          role_id VARCHAR(256) UNIQUE,
          parent_id VARCHAR(256),
          display_name VARCHAR(256),
          FOREIGN KEY (parent_id) REFERENCES resourcemanager_project (project_id)
      );

      CREATE TABLE iam_role_permission (
          role_key BIGINT,
          permission_key BIGINT,
          FOREIGN KEY (role_key) REFERENCES iam_role (role_key),
          FOREIGN KEY (permission_key) REFERENCES iam_permission (permission_key)
      );

      CREATE TABLE iam_role_binding (
          role_key BIGINT,
          user VARCHAR(256),
          parent_id VARCHAR(256),
          FOREIGN KEY (role_key) REFERENCES iam_role (role_key),
          FOREIGN KEY (parent_id) REFERENCES resourcemanager_project (project_id)
      );

      CREATE TABLE iam_machine_user (
          machine_user_key BIGINT PRIMARY KEY AUTO_INCREMENT,
          machine_user_id VARCHAR(256) UNIQUE,
          display_name VARCHAR(256),
          parent_id VARCHAR(256),
          FOREIGN KEY (parent_id) REFERENCES resourcemanager_project (project_id)
      );

      CREATE TABLE rdb_cluster (
          cluster_key BIGINT PRIMARY KEY AUTO_INCREMENT,
          cluster_id VARCHAR(256) UNIQUE,
          parent_id VARCHAR(256),
          replicas INT,
          FOREIGN KEY (parent_id) REFERENCES resourcemanager_project (project_id)
      );

      CREATE TABLE rdb_cluster_instance (
          cluster_key BIGINT,
          instance_id VARCHAR(256),
          FOREIGN KEY (cluster_key) REFERENCES rdb_cluster (cluster_key),
          FOREIGN KEY (instance_id) REFERENCES compute_instance (instance_id)
      );

      INSERT INTO resourcemanager_project (
          project_id,
          display_name
      ) VALUES
          ('/', 'root'),
          ('todo', 'todo display name');
  

